# SPDX-FileCopyrightText: Copyright (c) 2025 Broadsage Corporation <containers@broadsage.com>
#
# SPDX-License-Identifier: Apache-2.0

---
name: Workflow-Specific Release

on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/*.yml'
      - '!.github/workflows/workflow-release.yml'
      - '!.github/workflows/version-docs.yml'

permissions:
  contents: write
  pull-requests: read

jobs:
  detect-changes:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      changed-workflows: ${{ steps.changes.outputs.workflows }}
      changed-workflows-array: ${{ steps.changes.outputs.workflows-array }}
      has-changes: ${{ steps.changes.outputs.has-changes }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 2

      - name: Detect changed workflows
        id: changes
        run: |
          echo "Detecting workflow changes..."
          
          # Get changed workflow files (exclude management workflows)
          changed_files=$(git diff --name-only HEAD~1 HEAD -- '.github/workflows/*.yml' | \
            grep -v -E '(workflow-release|version-docs)\.yml$' || true)
          
          if [[ -z "$changed_files" ]]; then
            echo "No workflow changes detected"
            echo "has-changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Changed files:"
          echo "$changed_files"
          
          # Extract workflow names (without .yml extension)
          workflows=""
          workflows_array="["
          first=true
          
          for file in $changed_files; do
            if [[ $file == *.yml ]]; then
              workflow_name=$(basename "$file" .yml)
              if [[ -n "$workflows" ]]; then
                workflows="$workflows,$workflow_name"
              else
                workflows="$workflow_name"
              fi
              
              # Build JSON array for matrix
              if [[ "$first" == "true" ]]; then
                workflows_array="${workflows_array}\"$workflow_name\""
                first=false
              else
                workflows_array="${workflows_array},\"$workflow_name\""
              fi
            fi
          done
          
          workflows_array="${workflows_array}]"
          
          echo "Changed workflows: $workflows"
          echo "Changed workflows array: $workflows_array"
          echo "workflows=$workflows" >> $GITHUB_OUTPUT
          echo "workflows-array=$workflows_array" >> $GITHUB_OUTPUT
          echo "has-changes=true" >> $GITHUB_OUTPUT

  determine-version-bump:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    outputs:
      version-bump: ${{ steps.bump.outputs.bump-type }}
      is-dependency-update: ${{ steps.check-deps.outputs.is-dependency-update }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 100

      - name: Check if dependency update
        id: check-deps
        run: |
          # Check if this is a Dependabot PR or dependency-related commit
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]] || 
             [[ "${{ github.event.head_commit.message }}" =~ ^deps(\(.*\))?: ]]; then
            echo "is-dependency-update=true" >> $GITHUB_OUTPUT
            echo "This is a dependency update"
          else
            echo "is-dependency-update=false" >> $GITHUB_OUTPUT
            echo "This is not a dependency update"
          fi

      - name: Determine version bump type
        id: bump
        run: |
          commit_message="${{ github.event.head_commit.message }}"
          message="$commit_message"
          
          echo "Analyzing commit message: $message"
          
          # Check for breaking changes
          if [[ "$message" =~ BREAKING.CHANGE ]] || 
             [[ "$message" =~ ^[^:]*!: ]] ||
             [[ "$message" =~ ^feat!: ]] ||
             [[ "$message" =~ ^fix!: ]]; then
            echo "bump-type=major" >> $GITHUB_OUTPUT
            echo "Detected BREAKING CHANGE - major version bump"
          # Check for new features
          elif [[ "$message" =~ ^feat(\(.*\))?: ]] ||
               [[ "$message" =~ ^add(\(.*\))?: ]]; then
            echo "bump-type=minor" >> $GITHUB_OUTPUT
            echo "Detected new feature - minor version bump"
          # Everything else is patch (fixes, deps, docs, etc.)
          else
            echo "bump-type=patch" >> $GITHUB_OUTPUT
            echo "Detected patch change - patch version bump"
          fi

  create-workflow-releases:
    needs: [detect-changes, determine-version-bump]
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workflow: ${{ fromJson(needs.detect-changes.outputs.changed-workflows-array) }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Get latest version for workflow
        id: latest
        run: |
          workflow="${{ matrix.workflow }}"
          echo "Processing workflow: $workflow"
          
          # Get the latest tag for this specific workflow
          latest_tag=$(git tag -l --sort=-version:refname | grep "^${workflow}-v[0-9]*\.[0-9]*\.[0-9]*$" | head -n1 || echo "${workflow}-v0.0.0")
          echo "latest-tag=$latest_tag" >> $GITHUB_OUTPUT
          echo "Latest tag for $workflow: $latest_tag"

      - name: Calculate new version for workflow
        id: version
        run: |
          workflow="${{ matrix.workflow }}"
          latest_tag="${{ steps.latest.outputs.latest-tag }}"
          bump_type="${{ needs.determine-version-bump.outputs.version-bump }}"
          
          # Extract version from tag (remove workflow prefix and 'v')
          if [[ "$latest_tag" == "${workflow}-v0.0.0" ]]; then
            # First version for this workflow
            version="0.0.0"
          else
            version=${latest_tag#${workflow}-v}
          fi
          
          # Split version
          IFS='.' read -r major minor patch <<< "$version"
          
          # Default to 0 if parsing fails
          major=${major:-0}
          minor=${minor:-0}
          patch=${patch:-0}
          
          echo "Current version for $workflow: $major.$minor.$patch"
          echo "Bump type: $bump_type"
          
          # Calculate new version based on bump type
          case $bump_type in
            "major")
              new_major=$((major + 1))
              new_minor=0
              new_patch=0
              ;;
            "minor")
              new_major=$major
              new_minor=$((minor + 1))
              new_patch=0
              ;;
            "patch")
              new_major=$major
              new_minor=$minor
              new_patch=$((patch + 1))
              ;;
          esac
          
          # For first version, start at 1.0.0
          if [[ "$major" == "0" && "$minor" == "0" && "$patch" == "0" ]]; then
            new_major=1
            new_minor=0
            new_patch=0
          fi
          
          new_version="${workflow}-v$new_major.$new_minor.$new_patch"
          major_tag="${workflow}-v$new_major"
          minor_tag="${workflow}-v$new_major.$new_minor"
          
          echo "new-version=$new_version" >> $GITHUB_OUTPUT
          echo "major-tag=$major_tag" >> $GITHUB_OUTPUT
          echo "minor-tag=$minor_tag" >> $GITHUB_OUTPUT
          echo "workflow=$workflow" >> $GITHUB_OUTPUT
          
          echo "New version for $workflow will be: $new_version"
          echo "Major tag: $major_tag"
          echo "Minor tag: $minor_tag"

      - name: Create and push workflow tags
        run: |
          workflow="${{ matrix.workflow }}"
          new_version="${{ steps.version.outputs.new-version }}"
          major_tag="${{ steps.version.outputs.major-tag }}"
          minor_tag="${{ steps.version.outputs.minor-tag }}"
          
          echo "Creating tags for $workflow..."
          
          # Create specific version tag
          git tag -a "$new_version" -m "Release $new_version - $workflow workflow updates"
          
          # Update major version tag (force update)
          git tag -f -a "$major_tag" -m "Major version $major_tag for $workflow (latest: $new_version)"
          
          # Update minor version tag (force update)
          git tag -f -a "$minor_tag" -m "Minor version $minor_tag for $workflow (latest: $new_version)"
          
          # Push all tags
          git push origin "$new_version"
          git push --force origin "$major_tag"
          git push --force origin "$minor_tag"
          
          echo "Created and pushed tags for $workflow: $new_version, $major_tag, $minor_tag"

      - name: Generate workflow-specific release notes
        id: notes
        run: |
          workflow="${{ matrix.workflow }}"
          version="${{ steps.version.outputs.new-version }}"
          bump_type="${{ needs.determine-version-bump.outputs.version-bump }}"
          is_dep_update="${{ needs.determine-version-bump.outputs.is-dependency-update }}"
          
          # Create release notes
          cat > ${workflow}_release_notes.md << EOF
          ## Workflow: $workflow.yml
          
          **Version Bump:** $bump_type  
          **Dependency Update:** $is_dep_update
          
          ### Changes
          
          This release updates the \`$workflow.yml\` workflow with the following improvements:
          
          - Updated dependencies and security patches
          - Enhanced functionality and bug fixes
          - Improved performance and reliability
          
          ### Usage
          
          Use this specific workflow version:
          
          \`\`\`yaml
          uses: broadsage-containers/docker-ops/.github/workflows/$workflow.yml@$version
          \`\`\`
          
          Or pin to the major version for automatic compatible updates:
          
          \`\`\`yaml
          uses: broadsage-containers/docker-ops/.github/workflows/$workflow.yml@${{ steps.version.outputs.major-tag }}
          \`\`\`
          
          Or pin to the minor version for patch updates only:
          
          \`\`\`yaml
          uses: broadsage-containers/docker-ops/.github/workflows/$workflow.yml@${{ steps.version.outputs.minor-tag }}
          \`\`\`
          
          ### Full Changelog
          
          **Full Changelog**: https://github.com/broadsage-containers/docker-ops/compare/${{ steps.latest.outputs.latest-tag }}...$version
          EOF
          
          echo "Generated release notes for $workflow"
          echo "notes-file=${workflow}_release_notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release for workflow
        uses: actions/create-release@0cb9c9b65d5d1901c1f53e5e66eaf4afd303e70e # v1.1.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.new-version }}
          release_name: ${{ steps.version.outputs.new-version }}
          body_path: ${{ steps.notes.outputs.notes-file }}
          draft: false
          prerelease: false

  notify-consumers:
    needs: [detect-changes, create-workflow-releases]
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Notify about release
        run: |
          workflows="${{ needs.detect-changes.outputs.changed-workflows }}"
          echo "🚀 New release created for workflows: $workflows"
          echo "📝 Consuming repositories should consider updating their workflow references"
          echo "🔒 For maximum stability, pin to specific versions"